<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="1.0-triggers" author="settler">

        <sql>
            DROP TRIGGER IF EXISTS trg_jtb_object_privilege_insert;
            DROP TRIGGER IF EXISTS trg_jtb_object_privilege_delete;
            DROP TRIGGER IF EXISTS trg_jtb_object_privilege_update;
            DROP PROCEDURE IF EXISTS proc_refresh_user_privileges;
        </sql>

        <createProcedure>
            CREATE PROCEDURE proc_refresh_user_privileges(uid BIGINT)
            BEGIN
            DELETE FROM jtb_object_privilege
            WHERE prv_object_from = uid;
            INSERT INTO jtb_object_privilege SELECT
            u.id,
            u.id,
            'EDT'
            FROM usr_user u
            WHERE u.id = uid;
            END;
        </createProcedure>

        <createProcedure>
            CREATE TRIGGER trg_jtb_object_privilege_insert
            AFTER INSERT ON usr_user
            FOR EACH ROW
                BEGIN
                    CALL proc_refresh_user_privileges(NEW.id);
                END;
        </createProcedure>

        <createProcedure>
            CREATE TRIGGER trg_jtb_object_privilege_delete
            AFTER DELETE ON usr_user
            FOR EACH ROW
            BEGIN
            CALL proc_refresh_user_privileges(OLD.id);
            END;
        </createProcedure>

        <createProcedure>
            CREATE TRIGGER trg_jtb_object_privilege_update
            AFTER UPDATE ON usr_user
            FOR EACH ROW
            BEGIN
            CALL proc_refresh_user_privileges(OLD.id);
            END;
        </createProcedure>

        <rollback>
            DROP TRIGGER IF EXISTS trg_jtb_object_privilege_insert;
            DROP TRIGGER IF EXISTS trg_jtb_object_privilege_delete;
            DROP TRIGGER IF EXISTS trg_jtb_object_privilege_update;
            DROP PROCEDURE IF EXISTS proc_refresh_user_privileges;
        </rollback>

    </changeSet>


</databaseChangeLog>